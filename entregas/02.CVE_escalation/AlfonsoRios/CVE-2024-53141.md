# Vulnerabilidad reciente de escalación de privilegios utilizando desbordamiento
## CVE-2024-53141

**Autor:** AlfonsodRioss    

## Descripción:
CVE-2024-53141 es una vulnerabilidad en el kernel de Linux que afecta al subsistema netfilter, el sistema que da soporte a iptables, nftables y otras herramientas de filtrado de paquetes, específicamente dentro de ipset existe una feature llamada bitmap:ip, la cual utiliza bitmaps para dar seguimiento a rangos de ipv4. Esta falla permite que un usuario local sin privilegios pueda escalar sus permisos hasta obtener acceso root debido a las verificaciones de límites cuando se procesan rangos de IP. El error se encuentra en la función bitmap_ip_uadt que no maneja correctamente los parámetros IPSET_ATTR_CIDR, permitiendo que bajo ciertas condiciones los valores de las variables "ip" y "ip_to" se intercambien incorrectamente y omitan verificaciones, por lo que está a abierto a overflow y underflow.

El problema surge cuando el código convierte rangos de IP a su representación interna bitmap sin validar edge cases. Al proporcionar valores CIDR manipulados, el sistema omite verificaciones clave, causando un overflow o underflow en los cálculos internos del bitmap. Esto resulta en una escritura fuera de límites donde la memoria del kernel se sobrescribe con datos arbitrarios. Esta vulnerabilidad tiene un puntaje CVSS de 7.8 (Alto) y afecta versiones del kernel Linux desde la 2.6.39 hasta versiones anteriores a 4.19.325, 6.6.64, 6.11.11 y 6.12.2.

```
else if (tb[IPSET_ATTR_CIDR]) {
    u8 cidr = nla_get_u8(tb[IPSET_ATTR_CIDR]);
    ...
    ip_set_mask_from_to(ip, ip_to, cidr); // Issue arises here
}
...
if (ip_to > map->last_ip) // [Boundary check happens after the fact]
    return -IPSET_ERR_BITMAP_RANGE;
...
for (; !before(ip_to, ip); ip += map->hosts) { // Can iterate outside of allowed range
    e.id = ip_to_id(map, ip);
    ret = adtfn(set, &e, &ext, &ext, flags);
}
```

## Exploit:
El atacante comienza creando un conjunto bitmap:ip para gestionar direcciones IPv4. Luego proporciona rangos IP manipulados que engañan al sistema para realizar cálculos defectuosos. Estos cálculos erróneos desencadenan una escritura fuera de límites, otorgando al atacante control total de un primitivo de escritura en la memoria del kernel.

Con esta capacidad de escritura, el atacante sobrescribe cuidadosamente estructuras del kernel, como /proc/sys/kernel/core_pattern, obteniendo control completo. Desde ahí puede deshabilitar firewalls, instalar puertas traseras persistentes o instalar rootkits con acceso privilegiado completo al sistema.

[Proof of Concept](https://github.com/google/security-research/blob/master/pocs/linux/kernelctf/CVE-2024-53141_lts/docs/exploit.md)

## Parcheo:
La vulnerabilidad ha sido parcheada en el kernel Linux con el commit 35f56c554eb1b56b77b3cf197a6b00922d49033d. El parche agrega verificaciones de rango apropiadas y elimina las innecesarias en la función bitmap_ip_uadt.

El equipo del kernel Linux abordó el problema con un parche que aplica verificaciones de rango adecuadas al manejo de bitmap:ip. Específicamente, cuando tb[IPSET_ATTR_IP_TO] no está presente pero tb[IPSET_ATTR_CIDR] existe, los valores de ip e ip_to se intercambian ligeramente. Por lo tanto, la verificación de rango para ip debe realizarse más tarde. El parche consolida la lógica de validación de límites moviendo la validación de first_ip fuera del bloque condicional de rango IP-a-IP, asegurando que tanto las especificaciones de rango explícitas como los rangos calculados por CIDR se sometan a una validación adecuada antes de procesarse.

Los usuarios deben actualizar a las versiones del kernel Linux 4.19.325, 6.6.64, 6.11.11, 6.12.2 o posteriores para remediar esta vulnerabilidad.


### Referencias:
1. https://linuxsecurity.com/news/security-vulnerabilities/cve-2024-53141-root-level-escalation-linux-netfilter
1. https://nvd.nist.gov/vuln/detail/CVE-2024-53141
1. https://security-tracker.debian.org/tracker/CVE-2024-53141
1. https://gbhackers.com/poc-released-for-linux-kernel-vulnerability/
1. https://github.com/google/security-research/blob/master/pocs/linux/kernelctf/CVE-2024-53141_lts/docs/exploit.md